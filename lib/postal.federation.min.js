/*!
 *  * postal.federation - A base plugin for federating instances of postal.js across various boundaries.
 *  * Author: Jim Cowart (http://ifandelse.com)
 *  * Version: v0.5.5
 *  * Url: http://github.com/postaljs/postal.federation
 *  * License(s): (MIT OR GPL-2.0)
 */
!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],e):"object"==typeof exports?exports.postalFedx=e(require("lodash"),require("postal")):n.postalFedx=e(n._,n.postal)}(window,function(n,e){return function(n){function e(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return n[i].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var t={};return e.m=n,e.c=t,e.d=function(n,t,i){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:i})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var i=Object.create(null);if(e.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var o in n)e.d(i,o,function(e){return n[e]}.bind(null,o));return i},e.n=function(n){var t=n&&n.__esModule?function(){return n["default"]}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},e.p="",e(e.s=4)}([function(e,t){e.exports=n},function(n,t){n.exports=e},function(n,e){n.exports=function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}},function(n,e){function t(n,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}}n.exports=function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}},function(n,e,t){"use strict";function i(n){if(Object.prototype.hasOwnProperty.call(y,n))return y[n].apply(this,Array.prototype.slice.call(arguments,1))}function o(n){n=n||{};var e=I._transports;n.transport&&((e={})[n.transport]=I._transports[n.transport]),f.a.forEach(e,function(e){e.disconnect({target:n.target,instanceId:n.instanceId,doNotNotify:!!n.doNotNotify})})}function a(n,e,t){var i=Object.prototype.hasOwnProperty.call(m[t],n),o=i&&f.a.some(m[t][n],function(n){return g.a.configuration.resolver.compare(n,e)}),a="blacklist"===I._config.filterMode;return I._config.enabled&&(a&&(!i||i&&!o)||!a&&i&&o)}function r(n){if(I._ready){if(!Object.prototype.hasOwnProperty.call(S,n.packingSlip.type))throw new Error("postal.federation does not have a message handler for '"+n.packingSlip.type+"'.");S[n.packingSlip.type](n)}else I._inboundQueue.push(n)}function c(n){D.signalReady.apply(this,n)}function s(n){D.send.apply(this,n)}function u(n){D.onFederatedMsg.call(this,n)}t.r(e);var d,p,l=t(0),f=t.n(l),h=t(1),g=t.n(h);g.a.createUUID||(g.a.createUUID=function(){for(var n=[],e=0;e<36;e++)n[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return n[14]="4",n[19]="0123456789abcdef".substr(3&n[19]|8,1),n[8]=n[13]=n[18]=n[23]="-",n.join("")}),g.a.instanceId||(g.a.instanceId=function(n){return n&&(p=d,d=n,g.a.publish({channel:g.a.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:p,newId:d}})),d});var y={ping:function(){return{type:"federation.ping",instanceId:g.a.instanceId(),timeStamp:new Date,ticket:g.a.createUUID()}},pong:function(n){return{type:"federation.pong",instanceId:g.a.instanceId(),timeStamp:new Date,pingData:{instanceId:n.instanceId,timeStamp:n.timeStamp,ticket:n.ticket}}},message:function(n){return{type:"federation.message",instanceId:g.a.instanceId(),timeStamp:new Date,envelope:n}},disconnect:function(){return{type:"federation.disconnect",instanceId:g.a.instanceId(),timeStamp:new Date}},bundle:function(n){return{type:"federation.bundle",instanceId:g.a.instanceId(),timeStamp:new Date,packingSlips:n}}},b={enabled:!0,filterMode:"whitelist",filterDirection:"both"},k=function(){},I={_clients:[],_transports:{},_ready:!1,_inboundQueue:[],_outboundQueue:[],_signalQueue:[],_config:b},m={"in":{},out:{}},_=m,S={"federation.ping":function(n){n.source.setInstanceId(n.packingSlip.instanceId),n.source.handshakeComplete?n.source.sendPong(n.packingSlip):n.source.sendBundle([i("pong",n.packingSlip),i("ping")])},"federation.pong":function(n){n.source.handshakeComplete=!0,n.source.setInstanceId(n.packingSlip.instanceId),n.source.pings[n.packingSlip.pingData.ticket]&&(n.source.pings[n.packingSlip.pingData.ticket].callback({ticket:n.packingSlip.pingData.ticket,instanceId:n.packingSlip.instanceId,source:n.source}),n.source.pings[n.packingSlip.pingData.ticket]=void 0),f.a.includes(I._clients,n.packingSlip.instanceId)||I._clients.push(n.packingSlip.instanceId),g.a.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:n.source.instanceId,localId:g.a.instanceId(),transport:n.transport}})},"federation.disconnect":function(n){I._clients=f.a.without(I._clients,n.source.instanceId),o({transport:n.source.transportName,instanceId:n.source.instanceId,doNotNotify:!0})},"federation.message":function(n){var e=n.packingSlip.envelope;a(e.channel,e.topic,"in")&&(e.lastSender=n.packingSlip.instanceId,g.a.publish(e))},"federation.bundle":function(n){f.a.forEach(n.packingSlip.packingSlips,function(e){r(f.a.extend({},n,{packingSlip:e}))})}},v=t(2),w=t.n(v),x=t(3),M=t.n(x),j=function(){function n(e,t,i){w()(this,n),this.target=e,this.options=t||{},this.pings={},this.instanceId=i,this.handshakeComplete=!1}return M()(n,[{key:"sendPing",value:function(n){var e=i("ping");this.pings[e.ticket]={ticket:e.ticket,callback:n||k},this.send(e)}},{key:"sendPong",value:function(n){this.send(i("pong",n))}},{key:"sendBundle",value:function(n){this.send(i("bundle",n))}},{key:"sendMessage",value:function(n){if(this.handshakeComplete){n.originId=n.originId||g.a.instanceId();var e=f.a.clone(n);!this.instanceId||this.instanceId===e.lastSender||e.knownIds&&e.knownIds.length&&(!e.knownIds||f.a.includes(e.knownIds,this.instanceId))||(e.knownIds=(e.knownIds||[]).concat(f.a.without(I._clients,this.instanceId)),this.send(i("message",e)))}}},{key:"disconnect",value:function(){this.send(i("disconnect"))}},{key:"onMessage",value:function(n){this.shouldProcess()&&r({transport:this.transportName,packingSlip:n,source:this})}},{key:"shouldProcess",value:function(){return!0}},{key:"send",value:function(){throw new Error("An object deriving from FederationClient must provide an implementation for 'send'.")}},{key:"setInstanceId",value:function(n){this.instanceId=n}}],[{key:"extend",value:function(e,t){function i(){n.apply(this,arguments)}return i.prototype=Object.create(n.prototype),f.a.extend(i.prototype,e),f.a.extend(i,t),i}}]),n}(),D=g.a.fedx={FederationClient:j,packingSlips:y,handlers:S,clients:I._clients,transports:I._transports,filters:_,addFilter:function(n){n=f.a.isArray(n)?n:[n],f.a.forEach(n,function(n){n.direction=n.direction||I._config.filterDirection,f.a.forEach("both"===n.direction?["in","out"]:[n.direction],function(e){m[e][n.channel]?f.a.includes(m[e][n.channel],n.topic)||m[e][n.channel].push(n.topic):m[e][n.channel]=[n.topic]})})},removeFilter:function(n){n=f.a.isArray(n)?n:[n],f.a.forEach(n,function(n){n.direction=n.direction||I._config.filterDirection,f.a.forEach("both"===n.direction?["in","out"]:[n.direction],function(e){m[e][n.channel]&&f.a.includes(m[e][n.channel],n.topic)&&(m[e][n.channel]=f.a.without(m[e][n.channel],n.topic))})})},canSendRemote:function(n,e){return a(n,e,"out")},configure:function(n){if(n&&n.filterMode&&"blacklist"!==n.filterMode&&"whitelist"!==n.filterMode)throw new Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return n&&(I._config=f.a.defaults(n,b)),I._config},getPackingSlip:i,onFederatedMsg:r,sendMessage:function(n){I._ready?f.a.forEach(this.transports,function(e){e.sendMessage(n)}):I._outboundQueue.push(arguments)},disconnect:o,_getTransports:function(){return f.a.reduce(this.transports,function(n,e,t){return n[t]=!0,n},{})},signalReady:function(n,e,t){if(I._ready){var i=this._getTransports();switch(arguments.length){case 1:"function"==typeof n?t=n:"string"==typeof n&&((i={})[n]=this.transports[n],t=k);break;case 2:"string"==typeof n?(i={})[n]=this.transports[n]:i=n,t=e||k;break;case 3:(i={})[n]=[e]}f.a.forEach(i,f.a.bind(function(n,e){n="boolean"==typeof n?[]:n,this.transports[e].signalReady(n,t)},this))}else I._signalQueue.push(arguments)}};e["default"]=D,g.a.addWireTap(function(n,e){D.canSendRemote(e.channel,e.topic)&&D.sendMessage(e)}),g.a.subscribe({channel:g.a.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(I._ready=!0;I._signalQueue.length;)c(I._signalQueue.shift());for(;I._outboundQueue.length;)s(I._outboundQueue.shift());for(;I._inboundQueue.length;)u(I._inboundQueue.shift())}}),void 0!==g.a.instanceId()&&(I._ready=!0)}])});
//# sourceMappingURL=postal.federation.min.js.map
