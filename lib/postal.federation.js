/*!
 *  * postal.federation - A base plugin for federating instances of postal.js across various boundaries.
 *  * Author: Jim Cowart (http://ifandelse.com)
 *  * Version: v0.5.5
 *  * Url: http://github.com/postaljs/postal.federation
 *  * License(s): (MIT OR GPL-2.0)
 */
!function(n,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("postal")):"function"==typeof define&&define.amd?define(["lodash","postal"],e):"object"==typeof exports?exports.postalFedx=e(require("lodash"),require("postal")):n.postalFedx=e(n._,n.postal)}(window,function(n,e){return function(n){var e={};function t(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return n[i].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=n,t.c=e,t.d=function(n,e,i){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:i})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var o in n)t.d(i,o,function(e){return n[e]}.bind(null,o));return i},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="",t(t.s=4)}([function(e,t){e.exports=n},function(n,t){n.exports=e},function(n,e){n.exports=function(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}},function(n,e){function t(n,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,i.key,i)}}n.exports=function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}},function(n,e,t){"use strict";t.r(e);var i,o,a=t(0),r=t.n(a),c=t(1),s=t.n(c);function u(n){if(Object.prototype.hasOwnProperty.call(d,n))return d[n].apply(this,Array.prototype.slice.call(arguments,1))}s.a.createUUID||(s.a.createUUID=function(){for(var n=[],e=0;e<36;e++)n[e]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return n[14]="4",n[19]="0123456789abcdef".substr(3&n[19]|8,1),n[8]=n[13]=n[18]=n[23]="-",n.join("")}),s.a.instanceId||(s.a.instanceId=function(n){return n&&(o=i,i=n,s.a.publish({channel:s.a.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:o,newId:i}})),i});var d={ping:function(){return{type:"federation.ping",instanceId:s.a.instanceId(),timeStamp:new Date,ticket:s.a.createUUID()}},pong:function(n){return{type:"federation.pong",instanceId:s.a.instanceId(),timeStamp:new Date,pingData:{instanceId:n.instanceId,timeStamp:n.timeStamp,ticket:n.ticket}}},message:function(n){return{type:"federation.message",instanceId:s.a.instanceId(),timeStamp:new Date,envelope:n}},disconnect:function(){return{type:"federation.disconnect",instanceId:s.a.instanceId(),timeStamp:new Date}},bundle:function(n){return{type:"federation.bundle",instanceId:s.a.instanceId(),timeStamp:new Date,packingSlips:n}}},p={enabled:!0,filterMode:"whitelist",filterDirection:"both"},l=function(){},f={_clients:[],_transports:{},_ready:!1,_inboundQueue:[],_outboundQueue:[],_signalQueue:[],_config:p};function h(n){n=n||{};var e=f._transports;n.transport&&((e={})[n.transport]=f._transports[n.transport]),r.a.forEach(e,function(e){e.disconnect({target:n.target,instanceId:n.instanceId,doNotNotify:!!n.doNotNotify})})}var g={in:{},out:{}},y=g;function b(n,e,t){var i=Object.prototype.hasOwnProperty.call(g[t],n),o=i&&r.a.some(g[t][n],function(n){return s.a.configuration.resolver.compare(n,e)}),a="blacklist"===f._config.filterMode;return f._config.enabled&&(a&&(!i||i&&!o)||!a&&i&&o)}var k={"federation.ping":function(n){n.source.setInstanceId(n.packingSlip.instanceId),n.source.handshakeComplete?n.source.sendPong(n.packingSlip):n.source.sendBundle([u("pong",n.packingSlip),u("ping")])},"federation.pong":function(n){n.source.handshakeComplete=!0,n.source.setInstanceId(n.packingSlip.instanceId),n.source.pings[n.packingSlip.pingData.ticket]&&(n.source.pings[n.packingSlip.pingData.ticket].callback({ticket:n.packingSlip.pingData.ticket,instanceId:n.packingSlip.instanceId,source:n.source}),n.source.pings[n.packingSlip.pingData.ticket]=void 0),r.a.includes(f._clients,n.packingSlip.instanceId)||f._clients.push(n.packingSlip.instanceId),s.a.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:n.source.instanceId,localId:s.a.instanceId(),transport:n.transport}})},"federation.disconnect":function(n){f._clients=r.a.without(f._clients,n.source.instanceId),h({transport:n.source.transportName,instanceId:n.source.instanceId,doNotNotify:!0})},"federation.message":function(n){var e=n.packingSlip.envelope;b(e.channel,e.topic,"in")&&(e.lastSender=n.packingSlip.instanceId,s.a.publish(e))},"federation.bundle":function(n){r.a.forEach(n.packingSlip.packingSlips,function(e){I(r.a.extend({},n,{packingSlip:e}))})}};function I(n){if(f._ready){if(!Object.prototype.hasOwnProperty.call(k,n.packingSlip.type))throw new Error("postal.federation does not have a message handler for '"+n.packingSlip.type+"'.");k[n.packingSlip.type](n)}else f._inboundQueue.push(n)}var m=t(2),_=t.n(m),S=t(3),v=t.n(S),w=function(){function n(e,t,i){_()(this,n),this.target=e,this.options=t||{},this.pings={},this.instanceId=i,this.handshakeComplete=!1}return v()(n,[{key:"sendPing",value:function(n){var e=u("ping");this.pings[e.ticket]={ticket:e.ticket,callback:n||l},this.send(e)}},{key:"sendPong",value:function(n){this.send(u("pong",n))}},{key:"sendBundle",value:function(n){this.send(u("bundle",n))}},{key:"sendMessage",value:function(n){if(this.handshakeComplete){n.originId=n.originId||s.a.instanceId();var e=r.a.clone(n);!this.instanceId||this.instanceId===e.lastSender||e.knownIds&&e.knownIds.length&&(!e.knownIds||r.a.includes(e.knownIds,this.instanceId))||(e.knownIds=(e.knownIds||[]).concat(r.a.without(f._clients,this.instanceId)),this.send(u("message",e)))}}},{key:"disconnect",value:function(){this.send(u("disconnect"))}},{key:"onMessage",value:function(n){this.shouldProcess()&&I({transport:this.transportName,packingSlip:n,source:this})}},{key:"shouldProcess",value:function(){return!0}},{key:"send",value:function(){throw new Error("An object deriving from FederationClient must provide an implementation for 'send'.")}},{key:"setInstanceId",value:function(n){this.instanceId=n}}],[{key:"extend",value:function(e,t){function i(){n.apply(this,arguments)}return i.prototype=Object.create(n.prototype),r.a.extend(i.prototype,e),r.a.extend(i,t),i}}]),n}(),x=s.a.fedx={FederationClient:w,packingSlips:d,handlers:k,clients:f._clients,transports:f._transports,filters:y,addFilter:function(n){n=r.a.isArray(n)?n:[n],r.a.forEach(n,function(n){n.direction=n.direction||f._config.filterDirection,r.a.forEach("both"===n.direction?["in","out"]:[n.direction],function(e){g[e][n.channel]?r.a.includes(g[e][n.channel],n.topic)||g[e][n.channel].push(n.topic):g[e][n.channel]=[n.topic]})})},removeFilter:function(n){n=r.a.isArray(n)?n:[n],r.a.forEach(n,function(n){n.direction=n.direction||f._config.filterDirection,r.a.forEach("both"===n.direction?["in","out"]:[n.direction],function(e){g[e][n.channel]&&r.a.includes(g[e][n.channel],n.topic)&&(g[e][n.channel]=r.a.without(g[e][n.channel],n.topic))})})},canSendRemote:function(n,e){return b(n,e,"out")},configure:function(n){if(n&&n.filterMode&&"blacklist"!==n.filterMode&&"whitelist"!==n.filterMode)throw new Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return n&&(f._config=r.a.defaults(n,p)),f._config},getPackingSlip:u,onFederatedMsg:I,sendMessage:function(n){f._ready?r.a.forEach(this.transports,function(e){e.sendMessage(n)}):f._outboundQueue.push(arguments)},disconnect:h,_getTransports:function(){return r.a.reduce(this.transports,function(n,e,t){return n[t]=!0,n},{})},signalReady:function(n,e,t){if(f._ready){var i=this._getTransports();switch(arguments.length){case 1:"function"==typeof n?t=n:"string"==typeof n&&((i={})[n]=this.transports[n],t=l);break;case 2:"string"==typeof n?(i={})[n]=this.transports[n]:i=n,t=e||l;break;case 3:(i={})[n]=[e]}r.a.forEach(i,r.a.bind(function(n,e){n="boolean"==typeof n?[]:n,this.transports[e].signalReady(n,t)},this))}else f._signalQueue.push(arguments)}};e.default=x;function M(n){x.signalReady.apply(this,n)}function j(n){x.send.apply(this,n)}function D(n){x.onFederatedMsg.call(this,n)}s.a.addWireTap(function(n,e){x.canSendRemote(e.channel,e.topic)&&x.sendMessage(e)}),s.a.subscribe({channel:s.a.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(f._ready=!0;f._signalQueue.length;)M(f._signalQueue.shift());for(;f._outboundQueue.length;)j(f._outboundQueue.shift());for(;f._inboundQueue.length;)D(f._inboundQueue.shift())}}),void 0!==s.a.instanceId()&&(f._ready=!0)}])});